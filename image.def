Bootstrap: docker
From: mambaorg/micromamba:alpine

%help
    Container with micromamba on Alpine Linux.

%files
    environment.yml /environment.yml

%post
    eval "$(micromamba shell hook -s posix)"
    micromamba activate base

    micromamba create -y -f /environment.yml -n myenv


    echo 'eval "$(micromamba shell hook -s posix)"' >> /etc/profile
    echo 'micromamba activate myenv' >> /etc/profile

    apk add --no-cache wget tar gdb file curl
    
    ALPINE_GLIBC_BASE_URL="https://github.com/sgerrand/alpine-pkg-glibc/releases/download"
    ALPINE_GLIBC_VERSION="2.34-r0"
    wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub
    wget -q ${ALPINE_GLIBC_BASE_URL}/${ALPINE_GLIBC_VERSION}/glibc-${ALPINE_GLIBC_VERSION}.apk
    wget -q ${ALPINE_GLIBC_BASE_URL}/${ALPINE_GLIBC_VERSION}/glibc-bin-${ALPINE_GLIBC_VERSION}.apk
    wget -q ${ALPINE_GLIBC_BASE_URL}/${ALPINE_GLIBC_VERSION}/glibc-i18n-${ALPINE_GLIBC_VERSION}.apk
    apk add glibc-${ALPINE_GLIBC_VERSION}.apk glibc-bin-${ALPINE_GLIBC_VERSION}.apk glibc-i18n-${ALPINE_GLIBC_VERSION}.apk
    /usr/glibc-compat/bin/localedef -i en_US -f UTF-8 en_US.UTF-8
    echo "export LANG=en_US.UTF-8" > /etc/profile.d/locale.sh

    # Télécharger et installer Quarto
    QUARTO_VERSION="1.3.340"
    wget https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.tar.gz
    tar -xzf quarto-${QUARTO_VERSION}-linux-amd64.tar.gz
    ls -la /opt/
    echo "ou"
    
    ls -la quarto-${QUARTO_VERSION}-linux-amd64
    cp -r quarto-${QUARTO_VERSION}-linux-amd64/* /opt/quarto/
    rm -rf quarto-${QUARTO_VERSION}-linux-amd64*

    # Add Quarto to PATH
    echo 'export PATH=/opt/quarto/bin:$PATH' >> /etc/profile
%environment
    eval "$(micromamba shell hook -s posix)"
    micromamba activate myenv
    export PATH=/opt/quarto/bin:$PATH
%runscript
    python
    exec "$@"





