Bootstrap: docker
From: alpine:latest

%labels
    AUTHOR Quentin Festor
    VERSION 1.0
    DESCRIPTION "test de cr√©ation de sif pour computo"

%post
    apk add --no-cache curl
    wget -O environment.yml https://raw.githubusercontent.com/Qufst/create_apptainer.sif/main/environment.yml

    MICROMAMBA_URL="https://micro.mamba.pm/api/micromamba/linux-64/latest"
    MICROMAMBA_BIN="/usr/local/bin/micromamba"

    # Download micromamba
    curl -L -o $MICROMAMBA_BIN $MICROMAMBA_URL
    ls -a
    ls -a /usr/local/bin/micromamba
    # Verify the file is a valid executable
    if ! file $MICROMAMBA_BIN | grep -q 'executable'; then
        echo "Downloaded micromamba binary is not valid. Exiting."
        exit 1
    fi

    # Make micromamba executable
    chmod +x $MICROMAMBA_BIN

    # Create micromamba environment
    mkdir -p /opt/mamba
    $MICROMAMBA_BIN shell init -s bash -p /opt/mamba

    # Create the environment
    $MICROMAMBA_BIN create -y -n myenv -f environment.yml
    
%environment
    eval "$(micromamba shell hook --shell )"
    micromamba activate myenv
micromamba create -y -n myenv -f environment.yml
%help
    Utilisation : apptainer run image.sif --option
