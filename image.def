Bootstrap: docker
From: debian:bullseye-slim

%help
    Container with micromamba on Debian Linux and Quarto.

%files
    environment.yml /environment.yml

%post
    # Installer les dépendances
    apt-get update && apt-get install -y wget tar bzip2

    # Installer micromamba
    curl -L https://micromamba.snakepit.net/api/micromamba/linux-64/latest | tar -xvj -C /usr/local/bin/ --strip-components=1 bin/micromamba

    # Initialiser micromamba
    eval "$(micromamba shell hook -s posix)"
    micromamba activate base

    # Créer l'environnement micromamba à partir du fichier environment.yml
    micromamba create -y -f /environment.yml -n myenv

    # Ajouter des commandes pour activer l'environnement micromamba dans /etc/profile
    echo 'eval "$(micromamba shell hook -s posix)"' >> /etc/profile
    echo 'micromamba activate myenv' >> /etc/profile

    # Télécharger et installer Quarto
    QUARTO_VERSION="1.3.340"
    wget https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.tar.gz
    tar -xzf quarto-${QUARTO_VERSION}-linux-amd64.tar.gz
    cp -r quarto-${QUARTO_VERSION}-linux-amd64/* /opt/quarto/
    rm -rf quarto-${QUARTO_VERSION}-linux-amd64*

%environment
    # Variables d'environnement à définir dans le conteneur
    export PATH=/opt/quarto/bin:$PATH

%runscript
    # Script à exécuter lors de l'exécution du conteneur
    source /etc/profile
    exec "$@"
